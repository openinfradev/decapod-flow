apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: create-application
  namespace: argo
spec:
  arguments:
    parameters:
    - name: site_name
      value: "hanu-deploy-apps"
    - name: app_name
      value: "lma"
    - name: repository_url
      value: "https://github.com/openinfradev/decapod-manifests"
    - name: revision
      value: main
  templates:
  - name: createApp
    inputs:
      parameters:
      - name: path
      - name: namespace
      - name: target_cluster
    activeDeadlineSeconds: 900
    container:
      name: 'create'
      image: ghcr.io/openinfradev/argocd-cli:v2.0.1
      imagePullPolicy: IfNotPresent
      command:
      - /bin/bash
      - -c
      - |
        CD_APP=${SITE_NAME:0:8}-$PATH
        echo "argo-cd application name: $CD_APP"
        # log into Argo CD server
        ./argocd login $ARGO_SERVER --plaintext --insecure --username $ARGO_USERNAME \
        --password $ARGO_PASSWORD

        # check if app already exists.
        ./argocd app get $CD_APP 
        if [[ $? -ne 0 ]]; then
          echo "$CD_APP application is not in server"
          # create new application if not exists.
          ./argocd app create $CD_APP --repo $REPO --revision $REVISION --path $SITE_NAME/$TACO_APP/$PATH --dest-namespace $NAMESPACE --dest-name $TARGET_CLUSTER --project $TACO_APP --label app=$TACO_APP --directory-recurse
          if [[ $? -ne 0 ]]; then
            exit $?
          fi
        fi

        ./argocd app set $CD_APP --sync-policy automated --auto-prune
        ./argocd app sync $CD_APP --async
        ./argocd app wait $CD_APP --health
      envFrom:
        - secretRef:
            name: "decapod-argocd-config"
      env:
        - name: PATH
          value: "{{inputs.parameters.path}}"
        - name: SITE_NAME
          value: "{{workflow.parameters.site_name}}"
        - name: TARGET_CLUSTER
          value: "{{inputs.parameters.target_cluster}}"
        - name: TACO_APP
          value: "{{workflow.parameters.app_name}}"
        - name: NAMESPACE
          value: "{{inputs.parameters.namespace}}"
        - name: REPO
          value: "{{workflow.parameters.repository_url}}"
        - name: REVISION
          value: "{{workflow.parameters.revision}}"

  - name: AppGroup
    inputs:
      parameters:
      - name: list
    steps:
    - - name: "InstallAppGroup"
        template: createApp
        arguments:
          parameters:
          - {name: path, value: "{{item.path}}"}
          - {name: namespace, value: "{{item.namespace}}"}
          - {name: target_cluster, value: "{{workflow.parameters.site_name}}"}
        withParam: "{{inputs.parameters.list}}"

  - name: AppGroupOnAdmin
    inputs:
      parameters:
      - name: list
    steps:
    - - name: "InstallAppGroup"
        template: createApp
        arguments:
          parameters:
          - {name: path, value: "{{item.path}}"}
          - {name: namespace, value: "{{item.namespace}}"}
          - {name: target_cluster, value: "{{workflow.parameters.tks_admin}}"}
        withParam: "{{inputs.parameters.list}}"